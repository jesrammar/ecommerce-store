{% extends "base.html" %}
{% load static %}

{% block title %}Seguimiento pedido #{{ pedido.id }}{% endblock %}
{% block page_title %}Pedido #{{ pedido.id }}{% endblock %}
{% block page_subtitle %}Consulta el estado y el resumen completo de tu compra.{% endblock %}

{% block content %}
<div class="row g-3 mb-3">
  <div class="col-md-8">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <h5 class="card-title mb-3">Datos del pedido</h5>
        <p class="mb-1"><strong>Fecha:</strong> {{ pedido.created_at|date:"d/m/Y H:i" }}</p>
        <p class="mb-1"><strong>Cliente:</strong> {{ pedido.nombre|default:"—" }}</p>
        <p class="mb-1"><strong>Email:</strong> {{ pedido.email }}</p>
        <p class="mb-1"><strong>Teléfono:</strong> {{ pedido.telefono|default:"—" }}</p>
        <p class="mb-1">
          <strong>Método de pago:</strong> {{ pedido.pago_metodo|capfirst }}
        </p>
        <p class="mb-0">
          <strong>Total:</strong> {{ pedido.total }} {{ MONEDA|default:"€" }}
        </p>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <h5 class="card-title mb-3">Estado y envío</h5>

        <p class="mb-2">
          <strong>Estado de pago:</strong>
          {% if pedido.pago_estado == "pagado" %}
            <span class="badge text-bg-success">Pagado</span>
          {% elif pedido.pago_estado == "enviado" %}
            <span class="badge text-bg-primary">Enviado</span>
          {% else %}
            <span class="badge text-bg-secondary">{{ pedido.pago_estado|default:"pendiente"|capfirst }}</span>
          {% endif %}
        </p>

        <p class="mb-1"><strong>Dirección:</strong></p>
        <p class="small text-muted mb-2">
          {{ pedido.direccion }}, {{ pedido.cp }} {{ pedido.ciudad }}
        </p>

        <p class="mb-1">
          <strong>Método de envío:</strong>
          {{ pedido.envio_metodo.nombre|default:"—" }}
        </p>
        <p class="mb-3">
          <strong>Coste envío:</strong>
          {{ pedido.envio_coste|default:"0.00" }} {{ MONEDA|default:"€" }}
        </p>

        <p class="mb-0 small text-muted">
          <strong>Código seguimiento:</strong> {{ pedido.tracking_token|slice:":6" }}••••••
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Línea temporal simple de estado -->
<div class="mb-4">
  <div class="small text-muted mb-2">Progreso del pedido</div>
  <div class="d-flex flex-wrap gap-2">
    <span class="badge rounded-pill text-bg-success">Pedido recibido</span>
    {% if pedido.pago_estado == "pagado" or pedido.pago_estado == "enviado" %}
      <span class="badge rounded-pill text-bg-success">Pago confirmado</span>
    {% else %}
      <span class="badge rounded-pill text-bg-secondary">Pago pendiente</span>
    {% endif %}
    {% if pedido.pago_estado == "enviado" %}
      <span class="badge rounded-pill text-bg-success">Enviado</span>
    {% else %}
      <span class="badge rounded-pill text-bg-secondary">En preparación</span>
    {% endif %}
  </div>
</div>

<h4 class="mb-2">Artículos del pedido</h4>
<div class="table-responsive">
  <table class="table align-middle">
    <thead class="table-light">
      <tr>
        <th>Producto</th>
        <th class="text-end">Cant.</th>
        <th class="text-end">Precio</th>
        <th class="text-end">Subtotal</th>
      </tr>
    </thead>
    <tbody>
      {% for it in pedido.items.all %}
        <tr>
          <td>
            {{ it.titulo }}
            {% if it.personalizacion %}
              <div class="small text-muted mt-1">
                {% for key, value in it.personalizacion.items %}
                  <div>{{ key|capfirst }}: {{ value }}</div>
                {% endfor %}
              </div>
            {% endif %}
          </td>
          <td class="text-end">{{ it.cantidad }}</td>
          <td class="text-end">{{ it.precio_unit }} {{ MONEDA|default:"€" }}</td>
          <td class="text-end">{{ it.subtotal }} {{ MONEDA|default:"€" }}</td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="4" class="text-muted">No hay líneas en este pedido.</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="mt-3">
  {% if desde_mis_pedidos %}
    <a href="{% url 'pedidos:mis_pedidos' %}" class="btn btn-outline-secondary">
      ← Volver a mis pedidos
    </a>
  {% else %}
    <a href="{% url 'productos:catalogo' %}" class="btn btn-outline-secondary">
      ← Volver a la tienda
    </a>
  {% endif %}
</div>
{% endblock %}
